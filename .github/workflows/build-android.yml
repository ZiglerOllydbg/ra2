name: Build Android and Upload to Pgyer

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'ç‰ˆæœ¬åç§°'
        required: false
        default: ''

jobs:
  build-android:
    name: æž„å»º Android APK
    runs-on: ubuntu-latest
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # ç¼“å­˜ Library æ–‡ä»¶å¤¹
      - name: ç¼“å­˜ Unity Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-Android-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Android-
            Library-

      # æ›´æ–° Unity ç‰ˆæœ¬ä¿¡æ¯
      - name: æ›´æ–° ProjectVersion.txt
        run: |
          cat > ProjectSettings/ProjectVersion.txt << EOF
          m_EditorVersion: 2022.3.17f1
          m_EditorVersionWithRevision: 2022.3.17f1 (4fc78088f837)
          EOF
          echo "âœ… å·²æ›´æ–° Unity ç‰ˆæœ¬ä¿¡æ¯:"
          cat ProjectSettings/ProjectVersion.txt

      # æž„å»º Android APK
      - name: æž„å»º Unity é¡¹ç›® (Android)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: Android
          androidAppBundle: false
          androidKeystoreName: user.keystore
          androidKeystoreBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          androidKeystorePass: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          androidKeyaliasName: ${{ secrets.ANDROID_KEYALIAS_NAME }}
          androidKeyaliasPass: ${{ secrets.ANDROID_KEYALIAS_PASS }}
          buildName: RA
          unityVersion: 2022.3.17

      # ä¸Šä¼ åˆ°è’²å…¬è‹±
      - name: ä¸Šä¼ åˆ°è’²å…¬è‹±
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„ APK æ–‡ä»¶
          APK_FILE=$(find build/Android -name "*.apk" | head -n 1)
          
          if [ -z "$APK_FILE" ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ° APK æ–‡ä»¶"
            exit 1
          fi
          
          echo "æ‰¾åˆ° APK æ–‡ä»¶: $APK_FILE"
          
          # è®¾ç½®ç‰ˆæœ¬æè¿°
          VERSION_DESC="${{ github.event.inputs.version_name }}"
          if [ -z "$VERSION_DESC" ]; then
            VERSION_DESC="Android ç‰ˆæœ¬ - æž„å»ºäºŽ $(date '+%Y-%m-%d %H:%M:%S')\næäº¤: ${{ github.sha }}\nåˆ†æ”¯: ${{ github.ref_name }}"
          fi
          
          # ä¸Šä¼ åˆ°è’²å…¬è‹±
          RESPONSE=$(curl -s -F "file=@${APK_FILE}" \
            -F "_api_key=${{ secrets.PGYER_API_KEY }}" \
            -F "buildInstallType=2" \
            -F "buildPassword=${{ secrets.PGYER_BUILD_PASSWORD }}" \
            -F "buildUpdateDescription=${VERSION_DESC}" \
            https://www.pgyer.com/apiv2/app/upload)
          
          echo "è’²å…¬è‹±å“åº”: $RESPONSE"
          
          # æ£€æŸ¥ä¸Šä¼ æ˜¯å¦æˆåŠŸ
          CODE=$(echo $RESPONSE | grep -o '"code":[0-9]*' | grep -o '[0-9]*')
          
          if [ "$CODE" = "0" ]; then
            BUILD_KEY=$(echo $RESPONSE | grep -o '"buildKey":"[^"]*"' | cut -d'"' -f4)
            echo "âœ… ä¸Šä¼ æˆåŠŸ!"
            echo "ðŸ“± ä¸‹è½½é“¾æŽ¥: https://www.pgyer.com/${BUILD_KEY}"
            echo "ðŸ”‘ å®‰è£…å¯†ç : ${{ secrets.PGYER_BUILD_PASSWORD }}"
          else
            MESSAGE=$(echo $RESPONSE | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
            echo "âŒ ä¸Šä¼ å¤±è´¥: $MESSAGE"
            exit 1
          fi

      # ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° GitHub
      - name: ä¸Šä¼  APK åˆ° GitHub Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: Android-APK
          path: build/Android/*.apk


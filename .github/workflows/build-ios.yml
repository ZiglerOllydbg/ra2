name: Build iOS and Upload to Pgyer

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'ç‰ˆæœ¬åç§°'
        required: false
        default: ''

jobs:
  # ç¬¬ä¸€æ­¥ï¼šåœ¨ Linux ä¸Šç”¨ Unity å¯¼å‡º Xcode é¡¹ç›®ï¼ˆèŠ‚çœæˆæœ¬ï¼‰
  export-xcode-project:
    name: å¯¼å‡º Xcode é¡¹ç›® (Linux)
    runs-on: ubuntu-latest
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # ç¼“å­˜ Library æ–‡ä»¶å¤¹
      - name: ç¼“å­˜ Unity Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-iOS-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-iOS-
            Library-

      # æ›´æ–° Unity ç‰ˆæœ¬ä¿¡æ¯
      - name: æ›´æ–° ProjectVersion.txt
        run: |
          cat > ProjectSettings/ProjectVersion.txt << EOF
          m_EditorVersion: 2022.3.17f1
          m_EditorVersionWithRevision: 2022.3.17f1 (4fc78088f837)
          EOF
          echo "âœ… å·²æ›´æ–° Unity ç‰ˆæœ¬ä¿¡æ¯:"
          cat ProjectSettings/ProjectVersion.txt

      # åœ¨ Linux ä¸Šæ„å»º iOS Xcode é¡¹ç›®
      - name: ä½¿ç”¨ Unity å¯¼å‡º iOS Xcode é¡¹ç›®
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: iOS
          buildName: RA
          unityVersion: 2022.3.17

      # ä¸Šä¼  Xcode é¡¹ç›®åˆ° Artifacts
      - name: ä¸Šä¼  Xcode é¡¹ç›®
        uses: actions/upload-artifact@v3
        with:
          name: xcode-project
          path: build/iOS
          retention-days: 1

  # ç¬¬äºŒæ­¥ï¼šåœ¨ macOS ä¸Šç¼–è¯‘ Xcode é¡¹ç›®å¹¶æ‰“åŒ… IPA
  build-ipa:
    name: ç¼–è¯‘ IPA (macOS)
    runs-on: macos-latest
    needs: export-xcode-project
    
    steps:
      # ä¸‹è½½ Xcode é¡¹ç›®
      - name: ä¸‹è½½ Xcode é¡¹ç›®
        uses: actions/download-artifact@v3
        with:
          name: xcode-project
          path: build/iOS

      # è®¾ç½® Xcode ç­¾å
      - name: é…ç½® iOS ç­¾å
        run: |
          # åˆ›å»ºä¸´æ—¶ keychain
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # å¯¼å…¥è¯ä¹¦
          echo "${{ secrets.IOS_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          
          # åˆ›å»º provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      # æ„å»º IPA
      - name: æ„å»º IPA æ–‡ä»¶
        run: |
          cd build/iOS
          
          # åˆ›å»º ExportOptions.plist
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>ad-hoc</string>
              <key>teamID</key>
              <string>${{ secrets.IOS_TEAM_ID }}</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${{ secrets.IOS_BUNDLE_ID }}</key>
                  <string>${{ secrets.IOS_PROVISION_PROFILE_NAME }}</string>
              </dict>
          </dict>
          </plist>
          EOF
          
          # ä½¿ç”¨ xcodebuild æ„å»º IPA
          xcodebuild -project Unity-iPhone.xcodeproj \
            -scheme Unity-iPhone \
            -configuration Release \
            -archivePath ./RA.xcarchive \
            archive
          
          xcodebuild -exportArchive \
            -archivePath ./RA.xcarchive \
            -exportPath ./output \
            -exportOptionsPlist ExportOptions.plist

      # ä¸Šä¼ åˆ°è’²å…¬è‹±
      - name: ä¸Šä¼ åˆ°è’²å…¬è‹±
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„ IPA æ–‡ä»¶
          IPA_FILE=$(find build/iOS/output -name "*.ipa" | head -n 1)
          
          if [ -z "$IPA_FILE" ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ° IPA æ–‡ä»¶"
            exit 1
          fi
          
          echo "æ‰¾åˆ° IPA æ–‡ä»¶: $IPA_FILE"
          
          # è®¾ç½®ç‰ˆæœ¬æè¿°
          VERSION_DESC="${{ github.event.inputs.version_name }}"
          if [ -z "$VERSION_DESC" ]; then
            VERSION_DESC="iOS ç‰ˆæœ¬ - æ„å»ºäº $(date '+%Y-%m-%d %H:%M:%S')\næäº¤: ${{ github.sha }}\nåˆ†æ”¯: ${{ github.ref_name }}"
          fi
          
          # ä¸Šä¼ åˆ°è’²å…¬è‹±
          RESPONSE=$(curl -s -F "file=@${IPA_FILE}" \
            -F "_api_key=${{ secrets.PGYER_API_KEY }}" \
            -F "buildInstallType=2" \
            -F "buildPassword=${{ secrets.PGYER_BUILD_PASSWORD }}" \
            -F "buildUpdateDescription=${VERSION_DESC}" \
            https://www.pgyer.com/apiv2/app/upload)
          
          echo "è’²å…¬è‹±å“åº”: $RESPONSE"
          
          # æ£€æŸ¥ä¸Šä¼ æ˜¯å¦æˆåŠŸ
          CODE=$(echo $RESPONSE | grep -o '"code":[0-9]*' | grep -o '[0-9]*')
          
          if [ "$CODE" = "0" ]; then
            BUILD_KEY=$(echo $RESPONSE | grep -o '"buildKey":"[^"]*"' | cut -d'"' -f4)
            echo "âœ… ä¸Šä¼ æˆåŠŸ!"
            echo "ğŸ“± ä¸‹è½½é“¾æ¥: https://www.pgyer.com/${BUILD_KEY}"
            echo "ğŸ”‘ å®‰è£…å¯†ç : ${{ secrets.PGYER_BUILD_PASSWORD }}"
          else
            MESSAGE=$(echo $RESPONSE | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
            echo "âŒ ä¸Šä¼ å¤±è´¥: $MESSAGE"
            exit 1
          fi

      # æ¸…ç† keychain
      - name: æ¸…ç†
        if: always()
        run: |
          security delete-keychain build.keychain || true
          rm -f certificate.p12

      # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° GitHub
      - name: ä¸Šä¼  IPA åˆ° GitHub Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: iOS-IPA
          path: build/iOS/output/*.ipa


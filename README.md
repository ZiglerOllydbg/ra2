# Red Alert 2 - 红警项目研究

> 基于Unity帧同步的实时战略游戏开发项目

## 📋 项目概述

本项目是一个《红色警戒》风格的RTS游戏开发框架，采用帧同步技术实现多人实时对战，支持跨平台部署。

核心设计理念：**资源 → 电力 → 生产 → 扩张** 的闭环玩法循环

## 🏗️ 技术架构

> 详细架构文档：[Packages/ZLockstep/Runtime/README.md](Packages/ZLockstep/Runtime/README.md)

### 三层架构设计（奥卡姆剃刀原则）

```
┌────────────────────────────────────┐
│  【第3层】GameWorldBridge          │
│  Unity平台适配层                   │
│  - MonoBehaviour生命周期           │
│  - Unity资源管理                   │
└────────────┬───────────────────────┘
             │ 持有并驱动
             ▼
┌────────────────────────────────────┐
│  【第2层】Game                      │
│  应用控制层（纯C#）                │
│  - 游戏生命周期管理                │
│  - 创建唯一的zWorld                │
│  - 跨平台（Unity/服务器/测试）     │
└────────────┬───────────────────────┘
             │ 创建并驱动
             ▼
┌────────────────────────────────────┐
│  【第1层】zWorld                    │
│  游戏逻辑核心（纯C#）              │
│  - ECS架构                         │
│  - 确定性计算（zfloat/zVector3）  │
│  - 命令系统                        │
└────────────────────────────────────┘
```

**核心特性**：
- ✅ **严格分层**：每层职责单一，上层依赖下层，下层不知道上层
- ✅ **唯一zWorld**：整个游戏只有一个逻辑世界实例
- ✅ **跨平台**：Game和zWorld可在Unity/服务器/测试环境运行
- ✅ **确定性**：逻辑层使用定点数，保证帧同步

### 核心框架层 (ZLockstep)

#### 1. 命令系统 (Command System)
- **CommandManager**: 命令管理器，负责命令的排序和执行
- **ICommand**: 命令接口，所有游戏操作都通过Command驱动
- **支持来源**: 本地输入、AI、网络、回放

#### 2. 数学库 (定点数)
- **zfloat**: 定点数实现，避免浮点数误差
- **zVector2/3/4**: 定点数向量
- **zQuaternion**: 定点数四元数
- **zMatrix4x4**: 定点数矩阵
- **zRandom**: 确定性随机数生成器
- **zMathTool**: 数学工具类（包含查表法平方根等优化）

#### 3. 寻路系统 (Pathfinding)
- **A*算法**: 基础路径搜索 (`zAStarTool`)
- **地图配置**: 网格地图系统 (`zMapConfig`, `zMapTile`)
- **路径优化**: 路径平滑与简化
- **团队寻路**: 多单位协同移动（待实现）
- **RVO避障**: Reciprocal Velocity Obstacles 局部避障（待实现）
- **流场寻路**: 大规模单位优化（待实现）

#### 4. ECS架构 (Entity-Component-System)
- **EntityManager**: 实体管理器
- **ComponentManager**: 组件管理器
- **SystemManager**: 系统管理器
- **IComponent**: 组件接口（如 `PositionComponent`）
- **ISystem**: 系统接口

#### 5. 事件系统
- **EventManager**: 全局事件管理器
- **IEvent**: 事件接口
- 支持事件订阅/发布模式

#### 6. 时间系统
- **zTime**: 帧同步时间管理
- 固定时间步长
- 逻辑帧与渲染帧分离

### 游戏逻辑层

#### 1. 单位系统
- **步兵单位**: 动员兵、工程师等
- **载具单位**: 矿车、犀牛坦克、天启坦克等
- **空中单位**: 直升机、战斗机等（待实现）
- **海军单位**: 潜艇、驱逐舰等（待实现）
- **单位属性**: 生命值、移动速度、攻击力、防御力、视野等
- **单位状态机**: 空闲、移动、攻击、采集等状态

#### 2. 建筑系统
- **建造厂**: 游戏核心，生产建筑
- **资源建筑**: 矿场（采集）、电厂（能源）
- **生产建筑**: 兵营（步兵）、战车工厂（载具）
- **防御建筑**: 哨戒炮、防空炮等（待实现）
- **科技建筑**: 雷达站、科技中心等（待实现）
- **建筑放置**: 网格对齐、碰撞检测、预览系统

#### 3. 资源系统
- **资源类型**: 金钱、电力
- **资源采集**: 矿车AI（状态机驱动）
- **矿石系统**: 矿脉分布、矿石再生
- **资源存储**: 矿场容量限制

#### 4. 电力系统
- **电力供应**: 发电厂提供
- **电力消耗**: 建筑运行负载
- **电力不足惩罚**: 建筑效率下降、防御塔失效

#### 5. 战斗系统
- **攻击类型**: 近战、远程、对空、对地
- **伤害计算**: 护甲类型克制系统
- **弹道系统**: 追踪弹道、抛物线弹道（待实现）
- **爆炸范围**: AOE伤害计算（待实现）
- **视野与迷雾**: 战争迷雾系统（待实现）

#### 6. AI系统
- **单位AI**: 
  - 矿车自动采集AI
  - 战斗单位自动攻击
  - 防御建筑目标选择
- **战术AI**: 编队、巡逻、警戒（待实现）
- **战略AI**: 电脑玩家AI（简化规则）（待实现）

#### 7. 地图系统
- **地形系统**: 
  - 可通行性：陆地、水面、悬崖
  - 地形类型：草地、沙地、雪地等
- **分层系统**:
  - **寻路层**: 水层、陆地层、两栖层、空中层
  - **资源层**: 矿石分布、可采集区域
  - **视野层**: 战争迷雾、探索区域
- **地图编辑器**: 可视化地图制作工具（待实现）

#### 8. 科技与升级
- **建筑科技树**: 前置建筑依赖
- **单位升级**: 经验值、等级系统（待实现）
- **阵营差异**: 苏军/盟军不同科技树（待实现）

### 表现层

#### 1. 渲染系统
- **单位渲染**: 模型、动画、朝向
- **建筑渲染**: 建造动画、损毁效果
- **特效系统**: 爆炸、开火、弹道特效
- **UI系统**: HUD、小地图、建造栏

#### 2. 输入系统
- **单位选择**: 单选、框选、编组（Ctrl+数字）
- **指令输入**: 移动、攻击、建造、技能释放
- **镜头控制**: 平移、缩放、旋转

#### 3. 音效系统
- **单位音效**: 移动、攻击、死亡音效
- **建筑音效**: 建造完成、报警音效
- **背景音乐**: 阵营主题音乐

### 网络层（待实现）

#### 1. 联机对战
- **房间系统**: 创建、加入、离开
- **玩家匹配**: 快速匹配、自定义房间
- **断线重连**: 掉线保护机制

#### 2. 同步优化
- **指令压缩**: 减少网络传输量
- **延迟隐藏**: 预测与回滚
- **作弊检测**: 哈希校验

## 🚀 自动构建和发布

本项目已配置 GitHub Actions 构建，支持：

- ✅ Android APK 构建（Linux，快速且低成本）
- ✅ iOS IPA 构建（两阶段优化：Linux 导出 + macOS 编译，节省 67% 成本）
- ✅ 自动上传到蒲公英平台
- ✅ 手动触发构建，可自定义版本说明

### 快速开始

1. **配置 GitHub Secrets**: 查看 [.github/SETUP.md](.github/SETUP.md) 了解详细配置步骤

2. **手动触发构建**: 
   - 进入 GitHub 仓库的 `Actions` 标签
   - 选择要构建的平台（Android 或 iOS）
   - 点击 `Run workflow` 按钮
   - 可选填写版本名称

3. **下载安装**: 构建完成后，在 Actions 日志中获取蒲公英下载链接

详细配置说明请查看: [GitHub Actions 配置文档](.github/SETUP.md)


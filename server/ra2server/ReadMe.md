# RA2 服务器框架文档

## 1. 概述

RA2 服务器是一个基于 Netty 的 WebSocket 服务器，使用多线程架构实现游戏房间管理和帧同步机制。服务器采用模块化设计，主要包括网络通信、线程管理、房间服务和匹配服务等核心组件。

## 2. 网络层 (Netty)

### 2.1 WebSocket 服务器

WebSocket 服务器是整个系统的核心网络组件，基于 Netty 框架构建。

**主要类:**
- WebSocketServer: 主服务器类，负责启动和配置 Netty 服务器
- WebSocketServerInitializer: 初始化网络管道，配置编解码器和处理器
- WebSocketFrameHandler: 处理 WebSocket 帧的主要逻辑

**工作流程:**
1. 服务器监听指定端口（默认8080）
2. 客户端连接通过 HTTP 升级到 WebSocket 协议
3. 所有消息通过 WebSocketFrameHandler 处理
4. 根据消息类型将请求分发到匹配服务或房间服务

### 2.2 消息处理

服务器使用 JSON 格式进行客户端-服务器通信。所有消息都包含一个 `type` 字段用于标识消息类型：

```json
{
  "type": "match",
  "name": "Player1"
}
```

## 3. 线程架构

服务器采用多线程架构来处理不同的任务，确保高并发性能。

### 3.1 Netty 线程模型

Netty 使用主从 Reactor 模式：
- **Boss 线程组**: 处理连接请求
- **Worker 线程组**: 处理 I/O 事件和业务逻辑

### 3.2 业务线程

#### 匹配线程 (MatchService)
- 单独线程处理玩家匹配逻辑
- 维护等待匹配的玩家队列
- 实现两两匹配机制创建游戏房间

#### 房间线程 (RoomThread)
- 多个房间线程实例（默认4个）处理游戏房间逻辑
- 每个线程维持稳定的20帧频率
- 管理多个房间服务实例

### 3.3 线程间通信

线程间通过阻塞队列 (LinkedBlockingQueue) 进行通信，确保线程安全：
- MatchService 通过消息队列接收匹配请求
- RoomService 通过消息队列接收房间内消息

## 4. 房间管理系统

### 4.1 核心组件

#### RoomServiceManager
管理所有房间服务实例，负责创建和销毁房间服务，将房间服务分配到不同的房间线程。

#### RoomService
管理单个房间的所有业务逻辑，包括：
- 玩家加入和离开
- 游戏开始和准备
- 帧同步数据处理

#### Room
房间的核心数据结构，维护：
- 玩家列表和状态
- 游戏帧数据
- 准备状态和游戏状态

### 4.2 房间生命周期

1. **创建**: 由匹配服务创建，分配唯一房间ID
2. **运行**: 玩家准备、游戏开始、帧同步
3. **销毁**: 所有玩家断开连接后30秒自动销毁

## 5. 匹配系统

MatchService 负责玩家匹配逻辑：
- 维护等待匹配玩家队列
- 实现两两匹配算法
- 创建房间并通知玩家

## 6. 会话管理

WebSocketSessionManager 管理所有 WebSocket 连接：
- 维护频道与房间的映射关系
- 提供线程安全的消息发送机制
- 处理连接断开事件

## 7. 帧同步机制

服务器实现基于帧的同步机制：
- 保持稳定的20帧频率
- 收集所有玩家的输入数据
- 广播同步帧数据给所有玩家
- 处理玩家断线和重连

## 8. 启动流程

1. 初始化 MatchService
2. 启动 WebSocketServer
3. 初始化 RoomServiceManager 及其房间线程
4. 服务器开始监听连接

这个架构确保了服务器能够高效处理大量并发连接，同时保持游戏状态的一致性和实时性。

# 开发记录

## 2025-10-24
- [X] 服务器websocket通信、房间管理、帧同步基础代码
- [ ] 房间创建成功，发送给客户端的消息会报错，客户端收不到。
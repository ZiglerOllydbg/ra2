# ComponentManager 组件管理器

ComponentManager 是 ECS（Entity-Component-System）架构中的核心组件管理类，负责存储、检索和管理所有实体的组件。

## 功能概述

ComponentManager 提供了以下主要功能：

1. **组件存储**：使用类型字典存储所有组件，确保每个组件类型都有独立的存储空间
2. **组件生命周期管理**：添加、获取、检查和移除组件
3. **全局组件支持**：为全局实体提供专门的组件操作方法
4. **实体销毁处理**：当实体被销毁时自动清理其所有组件
5. **系统遍历支持**：提供按实体ID排序的组件遍历功能

## 核心设计

### 数据结构
```csharp
private readonly Dictionary<Type, Dictionary<int, IComponent>> _componentStores
```
- 外层字典键为组件类型（Type）
- 内层字典键为实体ID（int），值为组件实例（IComponent）
- 这种双重字典结构提供了高效的组件查找性能

### 全局实体支持
ComponentManager 通过 EntityManager 引用访问全局实体，提供专门的全局组件操作方法：
- `AddGlobalComponent<T>()` - 添加全局组件
- `GetGlobalComponent<T>()` - 获取全局组件
- `HasGlobalComponent<T>()` - 检查全局组件存在性
- `RemoveGlobalComponent<T>()` - 移除全局组件

### 确定性遍历
`GetAllEntityIdsWith<T>()` 方法专门用于系统遍历，返回按ID排序的实体ID集合，确保系统执行的确定性。

## API 说明

### 初始化
```csharp
public void Init(EntityManager entityManager)
```
初始化 ComponentManager 并设置 EntityManager 引用。

### 组件操作

#### 添加组件
```csharp
public void AddComponent<T>(Entity entity, T component) where T : IComponent
public void AddGlobalComponent<T>(T component) where T : IComponent
```

#### 获取组件
```csharp
public T GetComponent<T>(Entity entity) where T : IComponent
public T GetGlobalComponent<T>() where T : IComponent
```

#### 检查组件
```csharp
public bool HasComponent<T>(Entity entity) where T : IComponent
public bool HasGlobalComponent<T>() where T : IComponent
```

#### 移除组件
```csharp
public void RemoveComponent<T>(Entity entity) where T : IComponent
public void RemoveGlobalComponent<T>() where T : IComponent
```

### 系统支持
```csharp
public IEnumerable<int> GetAllEntityIdsWith<T>() where T : IComponent
```
获取所有拥有指定类型组件的实体ID集合，按ID排序以确保遍历的确定性。

### 实体生命周期
```csharp
public void EntityDestroyed(Entity entity)
```
当实体被销毁时调用，移除该实体的所有组件以释放资源。

## 使用示例

```csharp
// 初始化
var componentManager = new ComponentManager();
componentManager.Init(entityManager);

// 添加组件
var entity = entityManager.CreateEntity();
componentManager.AddComponent(entity, new TransformComponent());

// 获取组件
var transform = componentManager.GetComponent<TransformComponent>(entity);

// 检查组件
if (componentManager.HasComponent<TransformComponent>(entity)) {
    // 处理逻辑
}

// 全局组件操作
componentManager.AddGlobalComponent(new GlobalInfoComponent());
var globalInfo = componentManager.GetGlobalComponent<GlobalInfoComponent>();

// 系统遍历
foreach (int entityId in componentManager.GetAllEntityIdsWith<TransformComponent>()) {
    var transform = componentManager.GetComponent<TransformComponent>(new Entity(entityId));
    // 系统处理逻辑
}
```

## 设计优势

1. **类型安全**：通过泛型约束确保组件类型安全
2. **性能优化**：双重字典结构提供O(1)平均查找时间
3. **内存效率**：按组件类型分组存储，减少内存碎片
4. **确定性**：遍历方法保证执行顺序一致性
5. **易用性**：提供全局组件专用方法，简化常用操作

## 注意事项

1. 组件类型必须实现 IComponent 接口
2. 全局实体具有特殊ID，不应被销毁
3. 实体销毁时会自动清理其所有组件
4. 组件遍历应使用 `GetAllEntityIdsWith<T>()` 方法以确保确定性
# 实体移除逻辑

## 1. 死亡处理流程

实体的死亡和移除分为两个阶段处理：

### 死亡检测阶段：

- HealthSystem 检测实体生命值是否降到0
- 如果实体死亡，添加 DeathComponent 组件标记死亡状态
- 发布 EntityDiedEvent 事件通知表现层播放死亡动画

### 尸体移除阶段：

- DeathRemovalSystem 检查带有 DeathComponent 的实体是否达到尸体保留时间
- 当尸体保留时间到期后，系统会检查实体是否存在 ViewComponent 组件
- 如果存在 ViewComponent 组件，则销毁实体（但不发布 UnitDestroyedEvent）

## 2. 弹道销毁逻辑

对于弹道等特殊实体，销毁流程更简单：

- ProjectileSystem 在弹道命中目标后直接销毁
- 发布 UnitDestroyedEvent 事件通知表现层销毁视觉对象
- 移除弹道相关的逻辑组件，但保留 ViewComponent 组件供表现层处理

## 表现系统组件创建和移除

### 1. 组件创建

- PresentationSystem 监听 UnitCreatedEvent 事件
- 根据事件信息创建 Unity GameObject（使用预制体或默认可视化）
- 创建 ViewComponent 组件并添加到实体上，包含对 GameObject、Transform、Animator 等的引用

### 2. 组件移除

表现层有两种方式移除 ViewComponent 组件：

#### 通过死亡动画完成检测：

- 当实体死亡时，将其添加到 _dyingEntities 列表中跟踪
- 每帧检查死亡动画是否播放完毕
- 动画播放完毕后，销毁 GameObject 并移除 ViewComponent 组件

#### 通过 UnitDestroyedEvent 事件：

- 监听 UnitDestroyedEvent 事件（如弹道销毁）
- 直接销毁 GameObject 并移除 ViewComponent 组件

## 关键设计原则

- **逻辑与表现分离**：逻辑层只处理游戏状态，表现层负责视觉效果
- **事件驱动**：通过事件机制实现逻辑层与表现层的解耦
- **尸体保留机制**：死亡实体在一定时间内保留，确保死亡动画能完整播放
- **组件化管理**：使用 ECS 架构，通过组件管理实体的各种属性和状态

这套机制确保了游戏逻辑的稳定性和视觉效果的流畅性，同时保持了良好的架构分离。